<template id="tmpl-sidecar-contents">
  <style>
    #container {
      padding: 20px 5px;
    }

     .output-area {
      padding-top: 10px;
      padding-bottom: 10px;
      width: 100%;
      height: 100%;
      padding-left: 10px;

      border-left: solid #eee 1px;
      display: block;
    }

    .output-area:last-child {
      margin-bottom: 20px;
    }
  </style>
  <div id="container"></div>
</template>

<script>
(function () {
  var joust = require('jupyter-js-output-area')
  var OutputModel = joust.OutputModel;
  var OutputView = joust.OutputView;
  var importDoc = document.currentScript.ownerDocument;

  var resultPrototype = Object.create(HTMLElement.prototype);

  resultPrototype.createdCallback = function() {
    var t = importDoc.querySelector('#tmpl-sidecar-contents');
    var clone = document.importNode(t.content, true);
    var root = this.root = this.createShadowRoot();
    this.root.appendChild(clone);

    var ipc = require('ipc');

    var container = this.root.getElementById('container');

    ipc.on('message', function (message) {
        if (! message.parent_header && ! message.parent_header.msg_id) {
            return;
        }

        // The element we'll send the jupyter message
        var node;
        var parentID = 'parentID-' + message.parent_header.msg_id;
        node = root.querySelector('#' + parentID);

        var existedPrior = Boolean(node);

        if (!node) {
            // For every new parentID append a new output area
            var model = new OutputModel();
            var view = new OutputView(model, document);

            node = view.el;
            node.id = parentID;
            node.model = model; // Keep the model around with the node for now
        }

        var consumed = node.model.consumeMessage(message);
        if (consumed && ! existedPrior) {
          container.appendChild(node);
          node.scrollIntoView();
        }

    });
  };

  document.registerElement('sidecar-contents', {prototype: resultPrototype});
})();
</script>
